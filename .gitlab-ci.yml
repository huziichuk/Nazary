stages:
  - create-env
  - build
  - test
  - deploy

env-setup-job:
  stage: create-env
  script:
    - echo "$env" > .env
  artifacts:
    paths:
      - .env

build-job:
  stage: build
  script:
    - docker build -t nazary-api:$CI_COMMIT_SHORT_SHA  ./server/

test-job:
  stage: test
  script:
    - docker run --env-file .env --rm nazary-api:$CI_COMMIT_SHORT_SHA npm run test

deploy-job:
  stage: deploy
  script:
    - docker-compose -f docker-compose.yml up -d --build
